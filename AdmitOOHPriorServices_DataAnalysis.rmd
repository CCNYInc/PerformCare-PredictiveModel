---
title: "AdmitOOHPriorServices"
author: "Sulagna Patra"
date: "3/16/2021"
output: 
    html_document:
        toc: TRUE
        toc_float: TRUE
 ---


```{r Setup and DB Connection, include=FALSE}
source("1_setup_environment.R")
library(dataMaid)
library(DBI)
library(flextable)
library(dplyr)
library(tidyverse)
```

##Data Analysis for Member_History Table  
```{r,include= FALSE}
con <- DBI::dbConnect(odbc::odbc(), 
                      Driver = "SQL Server", 
                      Server =  "pcnjdevsql02",
                      Database = "PIE_Dev",
                      Trusted_Connection = "True")
dbListTables(con)

dbGetInfo(con)
```

```{r, include= FALSE}
tbl_long_cols_2 <- function(con, table) {
    cols_sorted <-
        odbc::odbcConnectionColumns(con, table) %>%
        dplyr::arrange(column_size) %>%
        pull(name)
    
    dplyr::tbl(con, table) %>%
        dplyr::select(tidyselect::all_of(cols_sorted))
}
AdmitOOHPriorServices<- tbl_long_cols_2(con, "RSPM_AdmitOOHPriorServices")%>%
    collect()

```
##Pulling AdmitOOHPriorServices_LOS Table
```{r, include= FALSE}
tbl_long_cols_2 <- function(con, table) {
    cols_sorted <-
        odbc::odbcConnectionColumns(con, table) %>%
        dplyr::arrange(column_size) %>%
        pull(name)
    
    dplyr::tbl(con, table) %>%
        dplyr::select(tidyselect::all_of(cols_sorted))
}
AdmitOOHPS_LOS<- tbl_long_cols_2(con, "RSPM_LOS_AdmitOOHPriorServices")%>%
    collect()

```




##Pulling CommunityTenure
```{r, include= FALSE}
tbl_long_cols_2 <- function(con, table) {
    cols_sorted <-
        odbc::odbcConnectionColumns(con, table) %>%
        dplyr::arrange(column_size) %>%
        pull(name)

    dplyr::tbl(con, table) %>%
        dplyr::select(tidyselect::all_of(cols_sorted))
}
CT_8Amdit<- tbl_long_cols_2(con, "RSPM_CommunityTenureFor8Admits")%>%
    collect()


```

```{r, include= FALSE}
tbl_long_cols_2 <- function(con, table) {
    cols_sorted <-
        odbc::odbcConnectionColumns(con, table) %>%
        dplyr::arrange(column_size) %>%
        pull(name)

    dplyr::tbl(con, table) %>%
        dplyr::select(tidyselect::all_of(cols_sorted))
}
CT_7Amdit<- tbl_long_cols_2(con, "RSPM_CommunityTenureFor7Admits")%>%
    collect()


```
```{r, include= FALSE}
tbl_long_cols_2 <- function(con, table) {
    cols_sorted <-
        odbc::odbcConnectionColumns(con, table) %>%
        dplyr::arrange(column_size) %>%
        pull(name)

    dplyr::tbl(con, table) %>%
        dplyr::select(tidyselect::all_of(cols_sorted))
}
CT_6Amdit<- tbl_long_cols_2(con, "RSPM_CommunityTenureFor6Admits")%>%
    collect()


```
```{r, include= FALSE}
tbl_long_cols_2 <- function(con, table) {
    cols_sorted <-
        odbc::odbcConnectionColumns(con, table) %>%
        dplyr::arrange(column_size) %>%
        pull(name)

    dplyr::tbl(con, table) %>%
        dplyr::select(tidyselect::all_of(cols_sorted))
}
CT_5Amdit<- tbl_long_cols_2(con, "RSPM_CommunityTenureFor5Admits")%>%
    collect()


```
```{r, include= FALSE}
tbl_long_cols_2 <- function(con, table) {
    cols_sorted <-
        odbc::odbcConnectionColumns(con, table) %>%
        dplyr::arrange(column_size) %>%
        pull(name)

    dplyr::tbl(con, table) %>%
        dplyr::select(tidyselect::all_of(cols_sorted))
}
CT_4Amdit<- tbl_long_cols_2(con, "RSPM_CommunityTenureFor4Admits")%>%
    collect()


```
```{r, include= FALSE}
tbl_long_cols_2 <- function(con, table) {
    cols_sorted <-
        odbc::odbcConnectionColumns(con, table) %>%
        dplyr::arrange(column_size) %>%
        pull(name)

    dplyr::tbl(con, table) %>%
        dplyr::select(tidyselect::all_of(cols_sorted))
}
CT_3Amdit<- tbl_long_cols_2(con, "RSPM_CommunityTenureFor3Admits")%>%
    collect()


```
```{r, include= FALSE}
tbl_long_cols_2 <- function(con, table) {
    cols_sorted <-
        odbc::odbcConnectionColumns(con, table) %>%
        dplyr::arrange(column_size) %>%
        pull(name)

    dplyr::tbl(con, table) %>%
        dplyr::select(tidyselect::all_of(cols_sorted))
}
CT_2Amdit<- tbl_long_cols_2(con, "RSPM_CommunityTenureFor2Admits")%>%
    collect()


```

#1.1.0 Observing the data structure
#Understanding Number of rows and columns
```{r dataset, rows and column}
dim(AdmitOOHPriorServices)

```

## Initial Information with description of their structure
```{r dataset, parameters}
str(AdmitOOHPriorServices)

```
## Creating a dataframe from the data
```{r}
AdmitDirectlyOOH <- data.frame(AdmitOOHPriorServices)
```
# Number of rows and Cols
```{r}
nrow(AdmitOOHPriorServices)
ncol(AdmitOOHPriorServices)
```
```{r}
names(AdmitOOHPriorServices)
summary(AdmitOOHPriorServices)
```

#Checking data for any missing values
```{r}
colSums(sapply(AdmitOOHPriorServices, is.na))
```



##Converting column to catagorical Variable
```{r, include=FALSE}
##SiteGroup
AdmitOOHPriorServices <- data.frame(AdmitOOHPriorServices)
AdmitOOHPriorServices$SiteGroup[AdmitOOHPriorServices$SiteGroup == 1]<-"BH"
AdmitOOHPriorServices$SiteGroup[AdmitOOHPriorServices$SiteGroup == 2]<-"DD"
AdmitOOHPriorServices$SiteGroup[AdmitOOHPriorServices$SiteGroup == 3]<- "SA" 

##MemberGender
AdmitOOHPriorServices <- data.frame(AdmitOOHPriorServices)
AdmitOOHPriorServices$MemberGender[AdmitOOHPriorServices$MemberGender == 1]<-"Female"
AdmitOOHPriorServices$MemberGender[AdmitOOHPriorServices$MemberGender == 2]<-"Male"
AdmitOOHPriorServices$MemberGender[AdmitOOHPriorServices$MemberGender == 3]<-"Unknown" 

##MemberRace
AdmitOOHPriorServices$MemberRaceEthnicity[AdmitOOHPriorServices$MemberRaceEthnicity == 1]<-"Black/African American"
AdmitOOHPriorServices$MemberRaceEthnicity[AdmitOOHPriorServices$MemberRaceEthnicity == 2]<-"Hispanic/Lationo"
AdmitOOHPriorServices$MemberRaceEthnicity[AdmitOOHPriorServices$MemberRaceEthnicity == 3]<-"Missing/Undetermined"
AdmitOOHPriorServices$MemberRaceEthnicity[AdmitOOHPriorServices$MemberRaceEthnicity == 4]<-"Other"
AdmitOOHPriorServices$MemberRaceEthnicity[AdmitOOHPriorServices$MemberRaceEthnicity == 5]<-"White"

##Memeber Age group
AdmitOOHPriorServices$MemberAgeGroup[AdmitOOHPriorServices$MemberAgeGroup == 1]<-"0-4"
AdmitOOHPriorServices$MemberAgeGroup[AdmitOOHPriorServices$MemberAgeGroup == 2]<-"5-10"
AdmitOOHPriorServices$MemberAgeGroup[AdmitOOHPriorServices$MemberAgeGroup == 3]<-"11-13"
AdmitOOHPriorServices$MemberAgeGroup[AdmitOOHPriorServices$MemberAgeGroup == 4]<-"14-17"
AdmitOOHPriorServices$MemberAgeGroup[AdmitOOHPriorServices$MemberAgeGroup == 5]<-"18-20"
AdmitOOHPriorServices$MemberAgeGroup[AdmitOOHPriorServices$MemberAgeGroup == 6]<-"21"
AdmitOOHPriorServices$MemberAgeGroup[AdmitOOHPriorServices$MemberAgeGroup == 7]<-">21"
```

#Cohort
How Many unique member Admit to OOH with Prior Services

```{r}
length(unique(AdmitOOHPriorServices$memberid))
# OOH_df <- AdmitOOHPriorServices %>%
#     select(OOH,memberid)%>%
#     group_by( OOH)%>%
#      summarise(dismem_ct=n_distinct(memberid))%>%
#      arrange(desc(dismem_ct))
#  OOH_df

```

# 2047 are admitted Admit to OOH with Prior Services

<!-- ## Clinical Profile -->
<!-- ## a. Diagnosis -->
<!-- ## what are the different Site Type and Site Group -->
```{r, include=FALSE}
OOH_SiteGr <- AdmitOOHPriorServices %>%
     dplyr::select(memberid,SiteGroup,SiteType)%>%
     group_by(SiteGroup,SiteType)%>%
     summarise(dismem=n_distinct(memberid))%>%
     arrange(desc(dismem))
OOH_SiteGr
```

```{r, include=FALSE}
AdmitOOHPriorServices <-data.frame(AdmitOOHPriorServices)
OOH_diag <- AdmitOOHPriorServices %>%
     dplyr::select(memberid,Diagnosis1,OOH)%>%
     group_by(memberid)%>%
     filter( OOH== 1)%>%
     summarise(disDiag=n_distinct(Diagnosis1))%>%
     arrange(desc(disDiag))
 OOH_diag

```
 
##Converting ICD10 code to SDoH Catagories
```{r,SDoH Diagnosis,include= FALSE}
AdmitOOHPriorServices<- data.frame(AdmitOOHPriorServices)
##Education
AdmitOOHPriorServices$Diagnosis1[AdmitOOHPriorServices$Diagnosis1 == 'Z550' |AdmitOOHPriorServices$Diagnosis1 == 'Z551'|AdmitOOHPriorServices$Diagnosis1 == 'Z558'|AdmitOOHPriorServices$Diagnosis1 == 'Z559'] <-"Education"

##Housing and Economic

AdmitOOHPriorServices$Diagnosis1[AdmitOOHPriorServices$Diagnosis1 >= 'Z590' &AdmitOOHPriorServices$Diagnosis1 <= 'Z599'] <-"Housing and Economic"

##Social Environment
AdmitOOHPriorServices$Diagnosis1[AdmitOOHPriorServices$Diagnosis1 >= 'Z602' &AdmitOOHPriorServices$Diagnosis1 <= 'Z605' |
                           AdmitOOHPriorServices$Diagnosis1 == 'Z600' |
                            AdmitOOHPriorServices$Diagnosis1 == 'Z608' |
                            AdmitOOHPriorServices$Diagnosis1 == 'Z609']<-"Social Environment"

##Stress
AdmitOOHPriorServices$Diagnosis1[
    AdmitOOHPriorServices$Diagnosis1 == 'Z734' | AdmitOOHPriorServices$Diagnosis1 == 'Z7389' |
        AdmitOOHPriorServices$Diagnosis1 == 'Z733' | AdmitOOHPriorServices$Diagnosis1 == 'Z739' |
        AdmitOOHPriorServices$Diagnosis1 == 'Z659' |
        AdmitOOHPriorServices$Diagnosis1 == 'Z658']<-"Stress"

##Experiences Crime,Violence,Judicial
AdmitOOHPriorServices$Diagnosis1[AdmitOOHPriorServices$Diagnosis1 >= 'Z650' & AdmitOOHPriorServices$Diagnosis1 <= 'Z655'] <-"Experiences Crime,Violence,Judicial"

##Upbringing
AdmitOOHPriorServices$Diagnosis1[AdmitOOHPriorServices$Diagnosis1 == 'Z6221' | AdmitOOHPriorServices$Diagnosis1 == 'Z6222' |
                            AdmitOOHPriorServices$Diagnosis1 == 'Z6229' |
                            AdmitOOHPriorServices$Diagnosis1 == 'Z62810' |
                            AdmitOOHPriorServices$Diagnosis1 == 'Z62811' |
                            AdmitOOHPriorServices$Diagnosis1 == 'Z62812' |
                            AdmitOOHPriorServices$Diagnosis1 =='Z62819']<-"Upbringing"

```
```{r,include=FALSE}
tb_SDoH<- AdmitOOHPriorServices %>%
    dplyr::select(Diagnosis1,memberid )%>%

    filter(AdmitOOHPriorServices$Diagnosis1 %in% c('Upbringing','Experiences Crime,Violence,Judicial','Stress','Social Environment','Housing and Economic','Education'))
#tb_SDoH

length(unique(tb_SDoH$memberid))

tb_SDoH_diag<-
    tb_SDoH %>% 
    group_by(Diagnosis1)%>%
    summarise(disMem=n_distinct(memberid))%>%
    arrange(desc(disMem))

tb_SDoH_diag

```
# Demographic
# Race
```{r}
df_Race <- AdmitOOHPriorServices%>%
          group_by(MemberRaceEthnicity )%>%
     summarise(count=n_distinct(memberid))
 df_Race 
```
##Member Gender
```{r}
df_Gender <- AdmitOOHPriorServices%>%
          group_by(MemberGender )%>%
     summarise(count=n_distinct(memberid))
 df_Gender 
```

```{r}
df_RaceVsGender <- AdmitOOHPriorServices%>%
          group_by(MemberRaceEthnicity,MemberGender )%>%
     summarise(count=n_distinct(memberid))
 df_RaceVsGender
 
df_RaceVsGender<- as.data.frame(df_RaceVsGender)
 plot_RaceVsGender<- ggplot(data=df_RaceVsGender,aes(x =MemberRaceEthnicity,y=count,fill =as.factor(MemberGender)))+ geom_bar(stat="identity",position = position_dodge())+ggtitle("Plot of Race With Gender") 
 plot_RaceVsGender
```
#Member Age of First Admission Date
```{r}
df_MemberAge <- AdmitOOHPriorServices%>%
          group_by(MemberAge )%>%
     summarise(count=n_distinct(memberid))%>%
       arrange(desc(count))
 df_MemberAge
```
#member Age Group
```{r}
df_MemberAgeGroup <- AdmitOOHPriorServices%>%
          group_by(MemberAgeGroup )%>%
     summarise(count=n_distinct(memberid))%>%
       arrange(desc(count))
 df_MemberAgeGroup
```
#Member Enrollment Age for First Service in CSOC
```{r}
df_MemberEnrollAge <- AdmitOOHPriorServices%>%
          group_by(MemberEnrollmentAge )%>%
     summarise(count=n_distinct(memberid))%>%
       arrange(desc(count))
df_MemberEnrollAge
```
#Member Enrollment Age Group for first service in CSOC
```{r}
df_MemberEnrollAgeGr <- AdmitOOHPriorServices%>%
          group_by(MemberEnrollmentAgeGroup )%>%
     summarise(count=n_distinct(memberid))%>%
       arrange(desc(count))
df_MemberEnrollAgeGr
```

##Zipcode Of Residence
```{r}
df_MemberZipcode <- AdmitOOHPriorServices%>%
          group_by(MemberZipCode )%>%
          summarise(count=n_distinct(memberid))%>%
          arrange(desc(count))
df_MemberZipcode
# write_csv(df_MemberZipcode, path = "memberZipcode.csv")
```

 
## Service Profile
##Number of Admission to OOH for each enrolled
```{r}

df_admit<- AdmitOOHPriorServices%>%
           dplyr:: select(memberid,MemberAge,admitdate,dischargedate)%>%
           group_by(memberid,MemberAge )%>%
           summarise(count=n_distinct(admitdate))%>%
           arrange(desc(count))
df_admitdate <- data.frame(df_admit)
df_admitdate
```
#Length of Stay
```{r, LOS}
AdmitOOHPriorServices$admitdate <- as.Date(AdmitOOHPriorServices$admitdate)
AdmitOOHPriorServices$dischargedate <- as.Date(AdmitOOHPriorServices$dischargedate)
##Find length of stay
df_los <-AdmitOOHPriorServices %>%
         dplyr::select(admitdate,dischargedate,memberid) %>%
         mutate(lengthofstay = dischargedate - admitdate)%>%
         arrange(desc(lengthofstay))
#df_los
df_los <- data.frame(df_los)
df_los$lengthofstay <-as.numeric(df_los$lengthofstay)
str(df_los)
summary(df_los$lengthofstay)
mean(df_los$lengthofstay)
##Find Mode of lengthofstay
# names(table(df_los$lengthofstay))[table(df_los$lengthofstay)==max(table(df_los$lengthofstay))]
```

##Boxplot 
```{r,Boxplot}
str(df_los)
library(MASS)
summary(df_los$lengthofstay)
range(df_los$lengthofstay)
boxplot(df_los$lengthofstay)
```


```{r, include=FALSE}
# summary(OOH_LOS$LOS)
# # mean(df_los$lengthofstay)
# boxplot(OOH_LOS$LOS , data=OOH_LOS)
```

```{r, CommunityTenureFor8Admits}
df_8Amdit<- CT_8Amdit%>%
           dplyr:: select(memberid,CommunityTenure1,CommunityTenure2,CommunityTenure3,CommunityTenure4,CommunityTenure5,CommunityTenure6,CommunityTenure7)
df_8Amdit <- data.frame(df_8Amdit)
df_8Amdit
```
```{r, Pivote dataset Wide to Long}

Admit8<-pivot_longer(df_8Amdit, -c(memberid), values_to = "Value", names_to = "Tenure")

Admit8<-as.data.frame(Admit8)
Admit8$memberid<-as.factor(Admit8$memberid)
Plot_8admit<-ggplot(data=Admit8, aes(x=Tenure, y=Value, group=(memberid), color=memberid)) +
    geom_line()+
    geom_point()
Plot_8admit
```

```{r, CommunityTenureFor7Admits}
df_7Amdit<- CT_7Amdit%>%
           dplyr:: select(memberid,CommunityTenure1,CommunityTenure2,CommunityTenure3,CommunityTenure4,CommunityTenure5,CommunityTenure6)
df_7Amdit <- data.frame(df_7Amdit)
df_7Amdit
```

```{r, Pivote dataset Wide to Long admit 7}

Admit7<-pivot_longer(df_7Amdit, -c(memberid), values_to = "Value", names_to = "Tenure")

Admit7<-as.data.frame(Admit7)
Admit7$memberid<-as.factor(Admit7$memberid)
Plot_7admit<-ggplot(data=Admit7, aes(x=Tenure, y=Value, group=(memberid), color=memberid)) +
    geom_line()+
    geom_point()+ggtitle("Plot of Member with 7 Admit")
Plot_7admit
```
```{r, CommunityTenureFor6Admits}
df_6Amdit<- CT_6Amdit%>%
           dplyr:: select(memberid,CommunityTenure1,CommunityTenure2,CommunityTenure3,CommunityTenure4,CommunityTenure5)
df_6Amdit <- data.frame(df_6Amdit)
df_6Amdit
#mem-55272
```

```{r, Plot with 6 admit}
Admit6<-pivot_longer(df_6Amdit, -c(memberid), values_to = "Value", names_to = "Tenure")

Admit6<-as.data.frame(Admit6)
Admit6$memberid<-as.factor(Admit6$memberid)
Plot_6admit<-ggplot(data=Admit6, aes(x=Tenure, y=Value, group=(memberid), color=memberid)) +
    geom_line()+
    geom_point()+ggtitle("Plot of Member with 6 Admit")
Plot_6admit
```
```{r, CommunityTenureFor5Admits}
df_5Amdit<- CT_5Amdit%>%
           dplyr:: select(memberid,CommunityTenure1,CommunityTenure2,CommunityTenure3,CommunityTenure4)
df_5Amdit <- data.frame(df_5Amdit)
df_5Amdit
```
```{r, CommunityTenureFor4Admits}
df_4Amdit<- CT_4Amdit%>%
           dplyr:: select(memberid,CommunityTenure1,CommunityTenure2,CommunityTenure3)
df_4Amdit <- data.frame(df_4Amdit)
df_4Amdit
#mem-73820
```


```{r, CommunityTenureFor3Admits}
df_3Amdit<- CT_3Amdit%>%
           dplyr:: select(memberid,CommunityTenure1,CommunityTenure2)
df_3Amdit <- data.frame(df_3Amdit)
df_3Amdit
```
```{r, CommunityTenureFor2Admits}
df_2Amdit<- CT_2Amdit%>%
           dplyr:: select(memberid,CommunityTenure)
df_2Amdit <- data.frame(df_2Amdit)
df_2Amdit
```
##This Informations are from RSPM_LOS_AdmitOOHPriorServices table which contain AdmitOOHPriorServices for the members

##Total number of admission to OOH Placement and their mean, Median and Mode

```{r}
summary(AdmitOOHPS_LOS$LOS)
# mean(df_los$lengthofstay)
boxplot(AdmitOOHPS_LOS$LOS , data=AdmitOOHPS_LOS)
hist(AdmitOOHPS_LOS$LOS,xlim=c(-60,1769), breaks=10,col="green", freq = FALSE)
#abline(v = 12, lwd = 2)
abline(v = median(AdmitOOHPS_LOS$LOS), col = "magenta", lwd = 4)
x <- seq(-60, 1769, length.out=1000)
y <- y <- with(AdmitOOHPS_LOS, dnorm(x, mean(LOS), sd(LOS)))
lines(x, y, col = "red")
```

```{r, mode of AdmitDirectlyOOH}
getmode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}

getmode(AdmitOOHPS_LOS$LOS)
names(table(AdmitOOHPS_LOS$LOS))[table(AdmitOOHPS_LOS$LOS)==max(table(AdmitOOHPS_LOS$LOS))]
```

## Total Number of Admission by each member and mean LOS
```{r, Each Member LOS}
LOS_permember<-AdmitOOHPS_LOS %>%
           group_by(memberid)%>%
        summarise(count=n(),Max_LOS=max(LOS),Min_LOS=min(LOS),Avg_LOS=mean(LOS),.groups = 'drop')%>%
    arrange(desc(count))
  LOS_permember<-data.frame( LOS_permember)
  LOS_permember
```

```{r, Each Member LOS}
summary(LOS_permember$Avg_LOS)
#plot(Avg_LOS~ count, data=LOS_permember)
ggplot(LOS_permember, aes(x=Avg_LOS, y=count)) + geom_point()
 hist(LOS_permember$Avg_LOS,xlim=c(0,1500), breaks=10,col="green", freq = FALSE)
#abline(v = 12, lwd = 2)
abline(v = median(LOS_permember$Avg_LOS), col = "magenta", lwd = 4)
```

