---
title: "AdmitDirectlyOOH"
author: "Sulagna Patra"
date: "3/14/2021"
output: html_document
---


```{r Setup and DB Connection, include=FALSE}
source("1_setup_environment.R")
library(dataMaid)
library(DBI)
library(flextable)
```

##Data Analysis for Member_History Table  
```{r,include= FALSE}
con <- DBI::dbConnect(odbc::odbc(), 
                      Driver = "SQL Server", 
                      Server =  "pcnjdevsql02",
                      Database = "PIE_Dev",
                      Trusted_Connection = "True")
dbListTables(con)

dbGetInfo(con)
```

```{r, include= FALSE}
tbl_long_cols_2 <- function(con, table) {
    cols_sorted <-
        odbc::odbcConnectionColumns(con, table) %>%
        dplyr::arrange(column_size) %>%
        pull(name)
    
    dplyr::tbl(con, table) %>%
        dplyr::select(tidyselect::all_of(cols_sorted))
}
AdmitDirectlyOOH<- tbl_long_cols_2(con, "RSPM_AdmitDirectlyOOH")%>%
    collect()

```
##Pulling RSPM_LOS_AdmitDirectlyOOH Table
```{r, include= FALSE}
tbl_long_cols_2 <- function(con, table) {
    cols_sorted <-
        odbc::odbcConnectionColumns(con, table) %>%
        dplyr::arrange(column_size) %>%
        pull(name)
    
    dplyr::tbl(con, table) %>%
        dplyr::select(tidyselect::all_of(cols_sorted))
}
AdmitDirectlyOOH_LOS<- tbl_long_cols_2(con, "RSPM_LOS_AdmitDirectlyOOH")%>%
    collect()

```
#1.1.0 Observing the data structure
#Understanding Number of rows and columns
```{r dataset, rows and column}
dim(AdmitDirectlyOOH)

```

## Initial Information with description of their structure
```{r dataset, parameters}
str(AdmitDirectlyOOH)

```
## Creating a dataframe from the data
```{r}
AdmitDirectlyOOH <- data.frame(AdmitDirectlyOOH)
```
# Number of rows and Cols
```{r}
nrow(AdmitDirectlyOOH)
ncol(AdmitDirectlyOOH)
```
```{r}
names(AdmitDirectlyOOH)
summary(AdmitDirectlyOOH)
```

#Checking data for any missing values
```{r}
colSums(sapply(AdmitDirectlyOOH, is.na))
```



##Converting column to catagorical Variable
```{r, include=FALSE}
##SiteGroup
AdmitDirectlyOOH <- data.frame(AdmitDirectlyOOH)
AdmitDirectlyOOH$SiteGroup[AdmitDirectlyOOH$SiteGroup == 1]<-"BH"
AdmitDirectlyOOH$SiteGroup[AdmitDirectlyOOH$SiteGroup == 2]<-"DD"
AdmitDirectlyOOH$SiteGroup[AdmitDirectlyOOH$SiteGroup == 3]<- "SA" 

##MemberGender
AdmitDirectlyOOH <- data.frame(AdmitDirectlyOOH)
AdmitDirectlyOOH$MemberGender[AdmitDirectlyOOH$MemberGender == 1]<-"Female"
AdmitDirectlyOOH$MemberGender[AdmitDirectlyOOH$MemberGender == 2]<-"Male"
AdmitDirectlyOOH$MemberGender[AdmitDirectlyOOH$MemberGender == 3]<-"Unknown" 

##MemberRace
AdmitDirectlyOOH$MemberRaceEthnicity[AdmitDirectlyOOH$MemberRaceEthnicity == 1]<-"Black/African American"
AdmitDirectlyOOH$MemberRaceEthnicity[AdmitDirectlyOOH$MemberRaceEthnicity == 2]<-"Hispanic/Lationo"
AdmitDirectlyOOH$MemberRaceEthnicity[AdmitDirectlyOOH$MemberRaceEthnicity == 3]<-"Missing/Undetermined"
AdmitDirectlyOOH$MemberRaceEthnicity[AdmitDirectlyOOH$MemberRaceEthnicity == 4]<-"Other"
AdmitDirectlyOOH$MemberRaceEthnicity[AdmitDirectlyOOH$MemberRaceEthnicity == 5]<-"White"

##Memeber Age group
AdmitDirectlyOOH$MemberAgeGroup[AdmitDirectlyOOH$MemberAgeGroup == 1]<-"0-4"
AdmitDirectlyOOH$MemberAgeGroup[AdmitDirectlyOOH$MemberAgeGroup == 2]<-"5-10"
AdmitDirectlyOOH$MemberAgeGroup[AdmitDirectlyOOH$MemberAgeGroup == 3]<-"11-13"
AdmitDirectlyOOH$MemberAgeGroup[AdmitDirectlyOOH$MemberAgeGroup == 4]<-"14-17"
AdmitDirectlyOOH$MemberAgeGroup[AdmitDirectlyOOH$MemberAgeGroup == 5]<-"18-20"
AdmitDirectlyOOH$MemberAgeGroup[AdmitDirectlyOOH$MemberAgeGroup == 6]<-"21"
AdmitDirectlyOOH$MemberAgeGroup[AdmitDirectlyOOH$MemberAgeGroup == 7]<-">21"
```

 ##Cohort
 ##How Many unique member Admit directly to OOH
 ## Clinical Profile
## a. Diagnosis

```{r}
length(unique(AdmitDirectlyOOH$memberid))
length(unique(AdmitDirectlyOOH$Diagnosis1))
DiagGr <- AdmitDirectlyOOH %>%
    dplyr::select(Diagnosis1,SiteGroup,memberid)%>%
    group_by(SiteGroup)%>%
     summarise(disDia=n_distinct(Diagnosis1))%>%
     arrange(desc(disDia))
DiagGr

```

# 1682 are admitted directly to OOH without any previous Services
# Number of Diagnosis in each Group such as BH,DD and SA



## what are the different Site Type and Site Group
```{r}
OOH_SiteGr <- AdmitDirectlyOOH %>%
     dplyr::select(memberid,SiteGroup,SiteType)%>%
     group_by(SiteGroup,SiteType)%>%
     summarise(dismem=n_distinct(memberid))%>%
     arrange(desc(dismem))
OOH_SiteGr
```

```{r}
OOH_diag <- AdmitDirectlyOOH %>%
     dplyr::select(memberid,Diagnosis1)%>%
     group_by(memberid)%>%
     summarise(disDiag=n_distinct(Diagnosis1))%>%
     
     arrange(desc(disDiag))
 OOH_diag
 
 
 
 
```
```{r}
OOH_mem <- AdmitDirectlyOOH %>%
     dplyr::select(memberid,Diagnosis1)%>%
     group_by(Diagnosis1)%>%
     summarise(disct=n_distinct(memberid))%>%
     
     arrange(desc(disct))
 OOH_mem
```

```{r, Plot Nummber of distinct diagnosis per member}
 OOH_diag<- as.data.frame( OOH_diag)
 plot_mem<- ggplot(data=OOH_diag,aes(x =memberid,y=disDiag))+ geom_bar(stat="identity")+ggtitle("Plot of Each With Diag") 
 plot_mem
```
 
##Converting ICD10 code to SDoH Catagories
```{r,SDoH Diagnosis,include= FALSE}
AdmitDirectlyOOH<- data.frame(AdmitDirectlyOOH)
##Education
AdmitDirectlyOOH$Diagnosis1[AdmitDirectlyOOH$Diagnosis1 == 'Z550' |AdmitDirectlyOOH$Diagnosis1 == 'Z551'|AdmitDirectlyOOH$Diagnosis1 == 'Z558'|AdmitDirectlyOOH$Diagnosis1 == 'Z559'] <-"Education"

##Housing and Economic

AdmitDirectlyOOH$Diagnosis1[AdmitDirectlyOOH$Diagnosis1 >= 'Z590' &AdmitDirectlyOOH$Diagnosis1 <= 'Z599'] <-"Housing and Economic"

##Social Environment
AdmitDirectlyOOH$Diagnosis1[AdmitDirectlyOOH$Diagnosis1 >= 'Z602' &AdmitDirectlyOOH$Diagnosis1 <= 'Z605' |
                           AdmitDirectlyOOH$Diagnosis1 == 'Z600' |
                            AdmitDirectlyOOH$Diagnosis1 == 'Z608' |
                            AdmitDirectlyOOH$Diagnosis1 == 'Z609']<-"Social Environment"

##Stress
AdmitDirectlyOOH$Diagnosis1[
    AdmitDirectlyOOH$Diagnosis1 == 'Z734' | AdmitDirectlyOOH$Diagnosis1 == 'Z7389' |
        AdmitDirectlyOOH$Diagnosis1 == 'Z733' | AdmitDirectlyOOH$Diagnosis1 == 'Z739' |
        AdmitDirectlyOOH$Diagnosis1 == 'Z659' |
        AdmitDirectlyOOH$Diagnosis1 == 'Z658']<-"Stress"

##Experiences Crime,Violence,Judicial
AdmitDirectlyOOH$Diagnosis1[AdmitDirectlyOOH$Diagnosis1 >= 'Z650' & AdmitDirectlyOOH$Diagnosis1 <= 'Z655'] <-"Experiences Crime,Violence,Judicial"

##Upbringing
AdmitDirectlyOOH$Diagnosis1[AdmitDirectlyOOH$Diagnosis1 == 'Z6221' | AdmitDirectlyOOH$Diagnosis1 == 'Z6222' |
                            AdmitDirectlyOOH$Diagnosis1 == 'Z6229' |
                            AdmitDirectlyOOH$Diagnosis1 == 'Z62810' |
                            AdmitDirectlyOOH$Diagnosis1 == 'Z62811' |
                            AdmitDirectlyOOH$Diagnosis1 == 'Z62812' |
                            AdmitDirectlyOOH$Diagnosis1 =='Z62819']<-"Upbringing"

```
```{r}
tb_SDoH<- AdmitDirectlyOOH %>%
    select(Diagnosis1,memberid )%>%

    filter(AdmitDirectlyOOH$Diagnosis1 %in% c('Upbringing','Experiences Crime,Violence,Judicial','Stress','Social Environment','Housing and Economic','Education'))
tb_SDoH

length(unique(tb_SDoH$memberid))

tb_SDoH_diag<-
    tb_SDoH %>% 
    group_by(Diagnosis1)%>%
    summarise(disMem=n_distinct(memberid))%>%
    arrange(desc(disMem))

tb_SDoH_diag

```
## 16 unique enrollees are related to SDoH diagnosis
##Stress	11	
##Housing and Economic	4	
##Experiences Crime,Violence,Judicial	1
 
 
# Demographic
# Race
```{r}
df_Race <- AdmitDirectlyOOH%>%
          group_by(MemberRaceEthnicity )%>%
     summarise(count=n_distinct(memberid))
 df_Race 
```
##Menber Gender
```{r}
df_Gender <- AdmitDirectlyOOH%>%
          group_by(MemberGender )%>%
     summarise(count=n_distinct(memberid))
 df_Gender 
```

```{r}
df_RaceVsGender <- AdmitDirectlyOOH%>%
          group_by(MemberRaceEthnicity,MemberGender )%>%
     summarise(count=n_distinct(memberid))
 df_RaceVsGender
 
df_RaceVsGender<- as.data.frame(df_RaceVsGender)
 plot_RaceVsGender<- ggplot(data=df_RaceVsGender,aes(x =MemberRaceEthnicity,y=count,fill =as.factor(MemberGender)))+ geom_bar(stat="identity",position = position_dodge())+ggtitle("Plot of Race With Gender") 
 plot_RaceVsGender
```
##member Age
```{r}
df_MemberAge <- AdmitDirectlyOOH%>%
          group_by(MemberAge )%>%
     summarise(count=n_distinct(memberid))%>%
       arrange(desc(count))
 df_MemberAge
```
##member Age Group
```{r}
df_MemberAgeGroup <- AdmitDirectlyOOH%>%
          group_by(MemberAgeGroup )%>%
     summarise(count=n_distinct(memberid))%>%
       arrange(desc(count))
 df_MemberAgeGroup
```
##member Enrollment Age 
```{r}
df_MemberEnrollAge <- AdmitDirectlyOOH%>%
          group_by(MemberEnrollmentAge )%>%
     summarise(count=n_distinct(memberid))%>%
       arrange(desc(count))
df_MemberEnrollAge
```
##member Enrollment Age Group
```{r}
df_MemberEnrollAgeGr <- AdmitDirectlyOOH%>%
          group_by(MemberEnrollmentAgeGroup )%>%
     summarise(count=n_distinct(memberid))%>%
       arrange(desc(count))
df_MemberEnrollAgeGr
```

##Zipcode Of Residence
```{r}
df_MemberZipcode <- AdmitDirectlyOOH%>%
          group_by(MemberZipCode )%>%
          summarise(count=n_distinct(memberid))%>%
          arrange(desc(count))
df_MemberZipcode
```

 
# ## Service Profile
# ##Number of Admission to OOH for each enrolled
```{r}

df_admit<- AdmitDirectlyOOH%>%
            select(memberid,MemberAge,admitdate,dischargedate)%>%
           group_by(memberid,MemberAge )%>%
           summarise(count=n_distinct(admitdate))%>%
           arrange(desc(count))
df_admitdate <- data.frame(df_admit)
df_admitdate
```
#Length of Stay
```{r}
AdmitDirectlyOOH$admitdate <- as.Date(AdmitDirectlyOOH$admitdate)
AdmitDirectlyOOH$dischargedate <- as.Date(AdmitDirectlyOOH$dischargedate)
##Find length of stay
df_los <-AdmitDirectlyOOH %>%
         select(admitdate,dischargedate,memberid)%>%
         #group_by(admitdate, dischargedate) %>%
         mutate(lengthofstay = dischargedate - admitdate)%>%
         arrange(desc(lengthofstay))
#df_los
df_los <- data.frame(df_los)
df_los$lengthofstay <-as.numeric(df_los$lengthofstay)
str(df_los)
summary(df_los$lengthofstay)
mean(df_los$lengthofstay)
##Find Mode of lengthofstay
names(table(df_los$lengthofstay))[table(df_los$lengthofstay)==max(table(df_los$lengthofstay))]
```

##Boxplot 
```{r}
str(df_los)
library(MASS)
summary(df_los$lengthofstay)
range(df_los$lengthofstay)
boxplot(df_los$lengthofstay)
```

##This Informations are from AdmitDirectlyOOH_LOS table which contain AdmitDirectly for the members

##Total number of admission to OOH Placement and their mean, Median and Mode

```{r}
summary(AdmitDirectlyOOH_LOS$LOS)
# mean(df_los$lengthofstay)
boxplot(AdmitDirectlyOOH_LOS$LOS , data=AdmitDirectlyOOH_LOS)
hist(AdmitDirectlyOOH_LOS$LOS,xlim=c(-60,1769), breaks=10,col="green", freq = FALSE)
#abline(v = 12, lwd = 2)
abline(v = median(AdmitDirectlyOOH_LOS$LOS), col = "magenta", lwd = 4)
x <- seq(-60, 1769, length.out=1000)
y <- with(AdmitDirectlyOOH_LOS, dnorm(x, mean(LOS), sd(LOS)))
lines(x, y, col = "red")
```

```{r, mode of AdmitDirectlyOOH}
getmode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}

getmode(AdmitDirectlyOOH_LOS$LOS)
names(table(AdmitDirectlyOOH_LOS$LOS))[table(AdmitDirectlyOOH_LOS$LOS)==max(table(AdmitDirectlyOOH_LOS$LOS))]
```

## Total Number of Admission by each member and mean LOS
```{r, Each Member LOS}
LOS_permember<-AdmitDirectlyOOH_LOS %>%
           group_by(memberid)%>%
        summarise(count=n(),Max_LOS=max(LOS),Min_LOS=min(LOS),Avg_LOS=mean(LOS),.groups = 'drop')%>%
    arrange(desc(count))
  LOS_permember<-data.frame( LOS_permember)
  LOS_permember
```

```{r, Each Member LOS}
summary(LOS_permember$Avg_LOS)
#plot(Avg_LOS~ count, data=LOS_permember)
ggplot(LOS_permember, aes(x=Avg_LOS, y=count)) + geom_point()
 hist(LOS_permember$Avg_LOS,xlim=c(0,1500), breaks=10,col="green", freq = FALSE)
#abline(v = 12, lwd = 2)
abline(v = median(LOS_permember$Avg_LOS), col = "magenta", lwd = 4)
```

